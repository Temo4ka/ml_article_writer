<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Генератор статей — ML Article Writer</title>
  <style>
    * { box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, sans-serif; max-width: 720px; margin: 0 auto; padding: 24px; background: #f5f5f5; }
    h1 { font-size: 1.5rem; margin-bottom: 0.25rem; }
    .subtitle { color: #666; font-size: 0.95rem; margin-bottom: 1.5rem; }
    label { display: block; font-weight: 500; margin-bottom: 0.35rem; }
    textarea, input[type="number"] { width: 100%; padding: 10px 12px; border: 1px solid #ccc; border-radius: 8px; font-size: 1rem; }
    textarea { min-height: 100px; resize: vertical; }
    input[type="number"] { width: 120px; }
    .row { margin-bottom: 1rem; }
    button { padding: 10px 20px; border: none; border-radius: 8px; font-size: 1rem; cursor: pointer; background: #2563eb; color: white; }
    button:hover { background: #1d4ed8; }
    button:disabled { background: #94a3b8; cursor: not-allowed; }
    .btn-secondary { background: #64748b; }
    .btn-secondary:hover { background: #475569; }
    #status { color: #64748b; font-size: 0.9rem; margin: 0.5rem 0; }
    #status.error { color: #dc2626; }
    #status.ok { color: #16a34a; }
    #result { min-height: 200px; margin-top: 0.5rem; white-space: pre-wrap; }
    .actions { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 1rem; }
  </style>
</head>
<body>
  <h1>Добро пожаловать в Генератор статей</h1>
  <p class="subtitle">Опишите тему и объём — модель напишет статью в вашем стиле.</p>

  <div class="row">
    <label for="topic">Содержание / тема статьи</label>
    <textarea id="topic" placeholder="Например: как машинное обучение меняет медицину">Например: как машинное обучение меняет медицину</textarea>
  </div>

  <div class="row">
    <label for="word_count">Количество слов (ориентир)</label>
    <input type="number" id="word_count" value="500" min="100" max="5000" step="100">
  </div>

  <div class="actions">
    <button type="button" id="loadBtn">Загрузить модель (при первом запуске)</button>
    <button type="button" id="genBtn" disabled>Сгенерировать статью</button>
  </div>
  <p id="status">Модель не загружена. Нажмите «Загрузить модель».</p>

  <div class="row">
    <label for="result">Текст статьи</label>
    <textarea id="result" readonly placeholder="Здесь появится сгенерированный текст"></textarea>
  </div>
  <div class="actions">
    <button type="button" id="exportBtn" class="btn-secondary">Сохранить в .docx</button>
  </div>

  <script>
    const status = document.getElementById('status');
    const loadBtn = document.getElementById('loadBtn');
    const genBtn = document.getElementById('genBtn');
    const topic = document.getElementById('topic');
    const wordCount = document.getElementById('word_count');
    const result = document.getElementById('result');
    const exportBtn = document.getElementById('exportBtn');

    function setStatus(msg, isError) {
      status.textContent = msg;
      status.className = isError ? 'error' : 'ok';
    }

    loadBtn.addEventListener('click', async () => {
      loadBtn.disabled = true;
      setStatus('Загрузка модели...');
      try {
        const r = await fetch('/api/load_model', { method: 'POST' });
        const data = await r.json();
        if (!r.ok) throw new Error(data.error || 'Ошибка загрузки');
        setStatus('Модель готова. Введите тему и нажмите «Сгенерировать статью».');
        genBtn.disabled = false;
        loadBtn.textContent = 'Модель загружена';
      } catch (e) {
        setStatus('Ошибка: ' + e.message, true);
        loadBtn.disabled = false;
      }
    });

    genBtn.addEventListener('click', async () => {
      const t = topic.value.trim();
      if (!t) { setStatus('Введите тему статьи.', true); return; }
      genBtn.disabled = true;
      setStatus('Генерация статьи...');
      try {
        const r = await fetch('/api/generate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ topic: t, word_count: parseInt(wordCount.value, 10) || 500 })
        });
        const data = await r.json();
        if (!r.ok) throw new Error(data.error || 'Ошибка генерации');
        result.value = data.text || '';
        setStatus('Статья сгенерирована. Можно сохранить в .docx.');
      } catch (e) {
        setStatus('Ошибка: ' + e.message, true);
      }
      genBtn.disabled = false;
    });

    exportBtn.addEventListener('click', async () => {
      const text = result.value.trim();
      if (!text) { setStatus('Нет текста. Сначала сгенерируйте статью.', true); return; }
      try {
        const r = await fetch('/api/export_docx', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text })
        });
        if (!r.ok) throw new Error('Ошибка экспорта');
        const blob = await r.blob();
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'article.docx';
        a.click();
        URL.revokeObjectURL(a.href);
        setStatus('Файл article.docx сохранён.');
      } catch (e) {
        setStatus('Ошибка: ' + e.message, true);
      }
    });
  </script>
</body>
</html>
